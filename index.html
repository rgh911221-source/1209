<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPPH æŠ—è‡ªç”±åŸºè©¦ç´™åˆ†æå„€ (å«CSVåŒ¯å‡º)</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­ç½® Inter å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* è¡¨æ ¼èˆ‡è¼¸å…¥æ¬„ä½æ¨£å¼ */
        th, td {
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #1f2937;
            color: white;
            font-size: 0.9rem;
        }
        /* è¼¸å…¥æ¬„ä½é€šç”¨æ¨£å¼ */
        .input-field {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            appearance: none; /* ç§»é™¤æ•¸å­—æ¬„ä½çš„é è¨­ç®­é ­ */
            -moz-appearance: textfield;
        }
        .input-field:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .text-left-input {
            text-align: left;
            padding-left: 0.5rem;
        }
        /* è®“è¡¨æ ¼åœ¨å°è¢å¹•ä¸Šå¯ä»¥æ»¾å‹• */
        .table-responsive {
            overflow-x: auto;
        }
        /* æ¨£å¼èª¿æ•´: ç¢ºä¿ Delete éˆ•æœ‰è¶³å¤ ç©ºé–“ */
        .action-cell {
            width: 80px;
            padding: 0 4px;
        }
        /* å…¬å¼å€å¡Šçš„æ•¸å­¸ç¬¦è™Ÿæ¨£å¼ */
        .formula-box {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            overflow-x: auto;
        }
    </style>
    <script>
        // å®šç¾©æ‰€æœ‰çµ„åˆ¥åŠå…¶é è¨­å€¼
        const INITIAL_GROUP_DEFS = [
            { key: 'Blank1', name: "ç©ºç™½è©¦ç´™ 1 (èƒŒæ™¯)", L: 49.8, a: -1.6, b: 3.2, type: 'Blank' },
            { key: 'Blank2', name: "ç©ºç™½è©¦ç´™ 2 (èƒŒæ™¯)", L: 49.8, a: -1.6, b: 3.2, type: 'Blank' },
            { key: 'DPPH_Ctrl', name: "DPPH ç´«è‰²çµ„ (0% æ¸…é™¤)", L: 45.8, a: 2.3, b: 0.8, type: 'Control' },
            { key: 'VitC_100', name: "ç¶­ç”Ÿç´ Cå°ç…§çµ„ (100% æ¸…é™¤)", L: 37.6, a: 2.3, b: 5.4, type: 'Control' },
            { key: 'Sample_0005', name: "æ¨£å“ A 0.005 mg/mL", L: 44.3, a: 2.8, b: 2.3, type: 'Sample' },
            { key: 'Sample_001', name: "æ¨£å“ A 0.01 mg/mL", L: 41.8, a: 2.6, b: 4.1, type: 'Sample' },
            { key: 'Sample_002', name: "æ¨£å“ A 0.02 mg/mL", L: 40.0, a: 3.7, b: 3.9, type: 'Sample' },
            { key: 'Sample_005', name: "æ¨£å“ A 0.05 mg/mL", L: 38.5, a: 2.4, b: 6.7, type: 'Sample' },
            { key: 'Sample_01', name: "æ¨£å“ A 0.1 mg/mL", L: 37.8, a: 2.4, b: 6.4, type: 'Sample' },
        ];

        // å…¨åŸŸç‹€æ…‹ï¼šå„²å­˜ç•¶å‰çš„çµ„åˆ¥æ•¸æ“šï¼Œç”¨æ–¼å‹•æ…‹å¢åˆª
        let currentGroups = [];
        let sampleCounter = 0; 
        
        // å…¨åŸŸç‹€æ…‹ï¼šå„²å­˜æœ€è¿‘ä¸€æ¬¡åˆ†æçš„çµæœï¼Œç”¨æ–¼ CSV åŒ¯å‡º
        let finalAnalysisResults = {}; 
        let blankAverageData = {};
        
        // æ ¸å¿ƒè¨ˆç®—å‡½æ•¸ï¼šè¨ˆç®— CIE L*a*b* ä¹‹é–“çš„è‰²å·® (Delta E)
        function calculateDeltaE(lab1, lab2) {
            const dL = lab2.L - lab1.L;
            const da = lab2.a - lab1.a;
            const db = lab2.b - lab1.b;
            return Math.sqrt(dL * dL + da * da + db * db);
        }

        // è®€å–è¼¸å…¥æ¬„ä½çš„æ•¸æ“š
        function collectData() {
            const collectedData = {};
            let hasError = false;

            // éæ­·ç•¶å‰çµ„åˆ¥ï¼Œå¾ DOM è®€å–æ•¸æ“š
            currentGroups.forEach(groupDef => {
                const key = groupDef.key;
                const L_input = document.getElementById(`L-${key}`);
                const a_input = document.getElementById(`a-${key}`);
                const b_input = document.getElementById(`b-${key}`);
                const name_input = document.getElementById(`name-${key}`);
                
                // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ (å› ç‚ºå‹•æ…‹å¢åˆª)
                if (!L_input) return;

                const L = parseFloat(L_input.value);
                const a = parseFloat(a_input.value);
                const b = parseFloat(b_input.value);
                const name = name_input.value.trim();

                // ç°¡æ˜“è¼¸å…¥é©—è­‰
                const inputs = [L_input, a_input, b_input];
                if (isNaN(L) || isNaN(a) || isNaN(b) || name === "") {
                    // å°‡ç„¡æ•ˆçš„æ¬„ä½æ¨™è¨˜ç‚ºç´…è‰²
                    inputs.forEach(input => {
                        if (isNaN(parseFloat(input.value))) {
                            input.style.borderColor = 'red';
                        } else {
                            input.style.borderColor = '#ccc';
                        }
                    });
                    if (name === "") name_input.style.borderColor = 'red';
                    hasError = true;
                    return; // è·³éæ­¤çµ„
                }
                
                // ç§»é™¤å¯èƒ½çš„éŒ¯èª¤æ¨™è¨˜
                [...inputs, name_input].forEach(input => input.style.borderColor = '#ccc');

                collectedData[key] = { L, a, b, name };
                
                // æ›´æ–° currentGroups ä¸­çš„åç¨±ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ¸²æŸ“æ™‚ä¿ç•™ä½¿ç”¨è€…è¼¸å…¥çš„åç¨±
                groupDef.name = name; 
            });

            if (hasError) {
                document.getElementById('analysisMessage').textContent = 'âš ï¸ è«‹æª¢æŸ¥æ‰€æœ‰ L, a*, b* æ¬„ä½ï¼Œç¢ºä¿è¼¸å…¥ç‚ºæœ‰æ•ˆæ•¸å­—ï¼';
                document.getElementById('analysisMessage').classList.replace('text-green-600', 'text-red-600');
                return null;
            }
            
            document.getElementById('analysisMessage').textContent = 'âœ… æ•¸æ“šè®€å–æˆåŠŸï¼Œæ­£åœ¨åŸ·è¡Œåˆ†æ...';
            document.getElementById('analysisMessage').classList.replace('text-red-600', 'text-green-600');
            return collectedData;
        }

        function runAnalysis() {
            const data = collectData(); // è®€å–æ•¸æ“š

            if (!data) return; // å¦‚æœæ•¸æ“šæœ‰èª¤ï¼Œå‰‡åœæ­¢åˆ†æ

            // å¿…é ˆç¢ºä¿é—œéµå°ç…§çµ„å­˜åœ¨æ–¼æ•¸æ“šä¸­
            if (!data.Blank1 || !data.Blank2 || !data.DPPH_Ctrl || !data.VitC_100) {
                 document.getElementById('analysisMessage').textContent = 'ğŸ›‘ è­¦å‘Š: ç¼ºå°‘ç©ºç™½çµ„æˆ–æ¨™æº–å°ç…§çµ„æ•¸æ“šï¼Œç„¡æ³•é€²è¡Œæ ¡æ­£åˆ†æï¼';
                 document.getElementById('analysisMessage').classList.replace('text-green-600', 'text-red-600');
                 // æ¸…ç©ºçµæœä¸¦åœæ­¢
                 finalAnalysisResults = {};
                 blankAverageData = {};
                 displayResults(null, 0, 0, null);
                 return;
            }

            const results = {};
            const DPPH_Ctrl = data.DPPH_Ctrl;

            // 1. è¨ˆç®—ç©ºç™½è©¦ç´™å¹³å‡å€¼ (ä½œç‚ºç™½è‰²èƒŒæ™¯åƒè€ƒ)
            const L_avg = (data.Blank1.L + data.Blank2.L) / 2;
            const a_avg = (data.Blank1.a + data.Blank2.a) / 2;
            const b_avg = (data.Blank1.b + data.Blank2.b) / 2;
            const Blank_Avg = { L: L_avg, a: a_avg, b: b_avg, name: "ç©ºç™½è©¦ç´™å¹³å‡å€¼" };

            // 2. è¨ˆç®—æ ¡æ­£åŸºæº– Delta E (ç©ºç™½å¹³å‡å€¼ vs DPPH ç´«è‰²çµ„)
            const deltaE_Blank_Ref = calculateDeltaE(DPPH_Ctrl, Blank_Avg);

            // 3. éæ­·æ‰€æœ‰çµ„åˆ¥ï¼Œé€²è¡Œæ ¸å¿ƒè¨ˆç®—
            for (const key in data) {
                const group = data[key];

                // 3.1. è¨ˆç®—æœªæ ¡æ­£ Delta E (èˆ‡ DPPH ç´«è‰²çµ„æ¯”è¼ƒ)
                const deltaE_Uncalibrated = calculateDeltaE(DPPH_Ctrl, group);

                // 3.2. è¨ˆç®—æ ¡æ­£ Delta E (èˆ‡ DPPH ç´«è‰²çµ„æ¯”è¼ƒï¼Œä¸¦é™¤ä»¥ç©ºç™½æ ¡æ­£åŸºæº–)
                let deltaE_Calibrated = 0;
                if (deltaE_Blank_Ref !== 0) {
                    deltaE_Calibrated = deltaE_Uncalibrated / deltaE_Blank_Ref;
                }

                results[key] = {
                    name: group.name,
                    L: group.L, a: group.a, b: group.b,
                    deltaE_Uncalibrated: deltaE_Uncalibrated,
                    deltaE_Calibrated: deltaE_Calibrated,
                    scavengingRate: 0 
                };
            }

            // 4. è¨ˆç®— 100% æ¸…é™¤ç‡åŸºæº– (ç¶­ç”Ÿç´ Cçµ„)
            const VitC_Ref_Calibrated_DeltaE = results.VitC_100.deltaE_Calibrated;

            // 5. è¨ˆç®—å„çµ„çš„ DPPH æ¸…é™¤ç‡ (%)
            for (const key in results) {
                const groupDef = currentGroups.find(g => g.key === key);
                // åªæœ‰æ¨£å“çµ„è¨ˆç®—æ¸…é™¤ç‡
                if (groupDef && groupDef.type !== 'Sample') {
                    results[key].scavengingRate = 'N/A';
                    continue;
                }
                
                const calibratedDeltaE = results[key].deltaE_Calibrated;
                let scavengingRate = 0;

                // ç¢ºä¿ 100% åŸºæº–ä¸ç‚ºé›¶
                if (VitC_Ref_Calibrated_DeltaE > 0) {
                    scavengingRate = (calibratedDeltaE / VitC_Ref_Calibrated_DeltaE) * 100;
                    if (scavengingRate < 0) scavengingRate = 0;
                }

                results[key].scavengingRate = scavengingRate.toFixed(2);
            }

            // 6. å„²å­˜çµæœåˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¸¦è¼¸å‡ºåˆ°ç¶²é 
            finalAnalysisResults = results;
            blankAverageData = {
                Blank_Avg: Blank_Avg,
                deltaE_Blank_Ref: deltaE_Blank_Ref,
                VitC_Ref_Calibrated_DeltaE: VitC_Ref_Calibrated_DeltaE
            };

            displayResults(results, deltaE_Blank_Ref, VitC_Ref_Calibrated_DeltaE, Blank_Avg);
        }

        function displayResults(results, deltaE_Blank_Ref, VitC_Ref_Calibrated_DeltaE, Blank_Avg) {
            const tableBody = document.getElementById('resultsTableBody');
            const summaryDiv = document.getElementById('summary');
            tableBody.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
            
            // è™•ç†çµæœç‚ºç©ºçš„æƒ…æ³ (ä¾‹å¦‚ç¼ºå°‘å°ç…§çµ„)
            if (!results || Object.keys(results).length === 0) {
                 summaryDiv.innerHTML = `<p class="text-center text-red-500 font-bold mb-4">ç„¡æ³•è¨ˆç®—æ ¡æ­£ Î”E èˆ‡æ¸…é™¤ç‡ï¼Œå› ç‚ºæ¨™æº–å°ç…§çµ„æ•¸æ“šä¸å®Œæ•´ã€‚</p>`;
                 document.getElementById('downloadCsvButton').disabled = true;
                 return;
            }
            
            document.getElementById('downloadCsvButton').disabled = false;


            // é¡¯ç¤ºæ ¡æ­£åŸºæº–
            summaryDiv.innerHTML = `
                <div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg shadow-md mb-6 md:flex md:space-x-8 justify-center items-center">
                    <p class="mb-2 md:mb-0 text-sm md:text-base">
                        <span class="font-semibold">Î”E æ ¡æ­£åŸºæº– (ç©ºç™½å¹³å‡ vs DPPH):</span> 
                        <span class="text-xl font-mono text-gray-700">${deltaE_Blank_Ref.toFixed(4)}</span>
                    </p>
                    <p class="text-sm md:text-base">
                        <span class="font-semibold">100% æ¸…é™¤ç‡æ ¡æ­£ Î”E (ç¶­ç”Ÿç´ C):</span> 
                        <span class="text-xl font-mono text-gray-700">${VitC_Ref_Calibrated_DeltaE.toFixed(4)}</span>
                    </p>
                </div>
            `;


            // æ’åºçµæœï¼šç©ºç™½ -> å°ç…§ -> æ¨£å“
            const orderedKeys = currentGroups.map(g => g.key);

            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            orderedKeys.forEach(key => {
                const result = finalAnalysisResults[key];
                
                // å¦‚æœçµæœé›†ä¸­æ²’æœ‰è©² key (ä¸è©²ç™¼ç”Ÿï¼Œä½†ä½œç‚ºå®‰å…¨æª¢æŸ¥)
                if (!result) return; 

                const groupDef = currentGroups.find(g => g.key === key);
                
                let rowClass = 'bg-white hover:bg-gray-50'; // Default
                
                // ä¾æ“šçµ„åˆ¥é¡å‹è¨­å®šä¸åŒçš„èƒŒæ™¯è‰²
                if (groupDef.type === 'Sample') {
                    // æ¨£å“çµ„ (Samples): æ·ºç´«è‰²
                    rowClass = 'bg-indigo-100 hover:bg-indigo-200';
                } else if (groupDef.type === 'Control') {
                    // æ¨™æº–å°ç…§çµ„ (DPPH, VitC): æ·ºé’è‰²
                    rowClass = 'bg-teal-100 hover:bg-teal-200';
                } else if (groupDef.type === 'Blank') {
                    // ç©ºç™½èƒŒæ™¯çµ„ (Blanks): æ·ºç°è‰²
                    rowClass = 'bg-gray-50 hover:bg-gray-100';
                }
                
                // æ ¼å¼åŒ–æ¸…é™¤ç‡
                const scavengingText = result.scavengingRate !== 'N/A'
                    ? `<span class="${parseFloat(result.scavengingRate) >= 100 ? 'text-purple-600 font-extrabold' : (parseFloat(result.scavengingRate) > 50 ? 'text-green-600 font-bold' : 'text-blue-600')}">${result.scavengingRate} %</span>`
                    : 'â€”';

                const row = `
                    <tr class="${rowClass}">
                        <td class="font-medium text-left">${result.name}</td>
                        <td>${result.L.toFixed(1)}</td>
                        <td>${result.a.toFixed(1)}</td>
                        <td>${result.b.toFixed(1)}</td>
                        <td class="font-mono text-gray-800">${result.deltaE_Uncalibrated.toFixed(4)}</td>
                        <td class="font-mono text-gray-800">${result.deltaE_Calibrated.toFixed(4)}</td>
                        <td>${scavengingText}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // åŠ å…¥ Blank_Avg è¡Œ
             tableBody.innerHTML += `
                <tr class="bg-gray-300 font-bold">
                    <td class="text-left">${Blank_Avg.name}</td>
                    <td>${Blank_Avg.L.toFixed(1)}</td>
                    <td>${Blank_Avg.a.toFixed(1)}</td>
                    <td>${Blank_Avg.b.toFixed(1)}</td>
                    <td>${deltaE_Blank_Ref.toFixed(4)}</td>
                    <td>1.0000 (åŸºæº–)</td>
                    <td>â€”</td>
                </tr>
            `;

        }
        
        // æ¸²æŸ“è¼¸å…¥è¡¨æ ¼
        function createInputTable() {
            const tableBody = document.getElementById('inputTableBody');
            tableBody.innerHTML = '';

            currentGroups.forEach(group => {
                const isSample = group.type === 'Sample';
                const isStandard = group.type === 'Control';
                const isBlank = group.type === 'Blank';

                // é¡è‰²å€åˆ†
                let rowClass = 'bg-white';
                if (isSample) {
                    rowClass = 'bg-indigo-100';
                } else if (isStandard) {
                    rowClass = 'bg-teal-100';
                } else if (isBlank) {
                    rowClass = 'bg-gray-50';
                }
                
                // åç¨±è¼¸å…¥æ¬„ä½
                const nameInput = `<input type="text" id="name-${group.key}" value="${group.name}" class="input-field text-left-input">`;
                
                // åˆªé™¤æŒ‰éˆ•
                const deleteButton = isSample 
                    ? `<button onclick="deleteGroup('${group.key}')" class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-lg transition duration-150 transform hover:scale-[1.05]">ç§»é™¤</button>`
                    : `â€”`; // éæ¨£å“çµ„ä¸å…è¨±ç§»é™¤

                const row = `
                    <tr class="${rowClass}">
                        <td>${nameInput}</td>
                        <td><input type="number" step="any" id="L-${group.key}" value="${group.L}" class="input-field"></td>
                        <td><input type="number" step="any" id="a-${group.key}" value="${group.a}" class="input-field"></td>
                        <td><input type="number" step="any" id="b-${group.key}" value="${group.b}" class="input-field"></td>
                        <td class="action-cell">${deleteButton}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        // å¢åŠ æ–°çš„æ¨£å“çµ„
        function addSampleGroup() {
            sampleCounter++;
            const newKey = `Sample_Dynamic_${sampleCounter}`;
            const newGroup = { 
                key: newKey, 
                name: `æ–°æ¨£å“ ${sampleCounter}`, 
                L: 0.0, a: 0.0, b: 0.0, // è¨­ç½®åˆå§‹å€¼ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…ä¿®æ”¹
                type: 'Sample' 
            };
            
            // å°‡æ–°çµ„åˆ¥æ·»åŠ åˆ°æ¨£å“çµ„ä¹‹å‰
            const firstSampleIndex = currentGroups.findIndex(g => g.type === 'Sample');
            if (firstSampleIndex !== -1) {
                currentGroups.splice(firstSampleIndex, 0, newGroup);
            } else {
                currentGroups.push(newGroup);
            }
            
            createInputTable(); // é‡æ–°æ¸²æŸ“è¼¸å…¥è¡¨æ ¼
            
            // æ»¾å‹•åˆ°æ–°å¢çš„æ¬„ä½
            document.getElementById(`name-${newKey}`).focus(); 
        }

        // åˆªé™¤æ¨£å“çµ„
        function deleteGroup(key) {
            // åªå…è¨±åˆªé™¤ Type ç‚º Sample çš„çµ„åˆ¥ (é˜²æ­¢åˆªé™¤æ¨™æº–å°ç…§çµ„)
            const groupIndex = currentGroups.findIndex(g => g.key === key && g.type === 'Sample');
            
            if (groupIndex !== -1) {
                // å¾ currentGroups ä¸­ç§»é™¤
                currentGroups.splice(groupIndex, 1);
                
                // é‡æ–°æ¸²æŸ“è¼¸å…¥è¡¨æ ¼
                createInputTable(); 
                
                // åˆªé™¤å¾Œè‡ªå‹•åŸ·è¡Œä¸€æ¬¡åˆ†æï¼Œæ›´æ–°çµæœ
                runAnalysis(); 
            }
        }

        // CSV åŒ¯å‡ºå‡½æ•¸
        function exportToCSV() {
            if (!finalAnalysisResults || Object.keys(finalAnalysisResults).length === 0) {
                document.getElementById('analysisMessage').textContent = 'ğŸ›‘ è­¦å‘Š: ç„¡æ³•åŒ¯å‡ºï¼Œè«‹å…ˆé»æ“Šã€ŒåŸ·è¡Œåˆ†æèˆ‡è¨ˆç®—ã€ç²å–çµæœã€‚';
                document.getElementById('analysisMessage').classList.replace('text-green-600', 'text-red-600');
                return;
            }

            // CSV æ¨™é ­
            let csv = "çµ„åˆ¥,L,a*,b*,æœªæ ¡æ­£ Î”E,æ ¡æ­£ Î”E,DPPH æ¸…é™¤ç‡ (%)\n";

            // 1. å¯«å…¥æ‰€æœ‰å¯¦é©—æ•¸æ“š (åŒ…å«ç©ºç™½ã€å°ç…§å’Œæ¨£å“)
            const orderedKeys = currentGroups.map(g => g.key);
            
            orderedKeys.forEach(key => {
                const result = finalAnalysisResults[key];
                if (result) {
                    const row = [
                        `"${result.name.replace(/"/g, '""')}"`, // è™•ç†åç¨±ä¸­çš„é€—è™Ÿæˆ–å¼•è™Ÿ
                        result.L.toFixed(4),
                        result.a.toFixed(4),
                        result.b.toFixed(4),
                        result.deltaE_Uncalibrated.toFixed(4),
                        result.deltaE_Calibrated.toFixed(4),
                        result.scavengingRate === 'N/A' ? 'N/A' : result.scavengingRate,
                    ].join(',');
                    csv += row + '\n';
                }
            });

            // 2. å¯«å…¥è¨ˆç®—å‡ºçš„å¹³å‡å€¼å’ŒåŸºæº–å€¼ (é¡å¤–è¡Œ)
            if (blankAverageData.Blank_Avg) {
                 const avg = blankAverageData.Blank_Avg;
                 const avgRow = [
                    `"${avg.name}"`, 
                    avg.L.toFixed(4),
                    avg.a.toFixed(4),
                    avg.b.toFixed(4),
                    blankAverageData.deltaE_Blank_Ref.toFixed(4),
                    '1.0000', // æ ¡æ­£ Delta E åŸºæº–å€¼
                    'N/A',
                 ].join(',');
                 csv += avgRow + '\n';
            }
            
            // 3. å¯«å…¥æ‘˜è¦åŸºæº– (é¡å¤–è¡Œ)
             csv += `\n`;
             csv += `æ‘˜è¦èˆ‡åŸºæº–\n`;
             csv += `Delta E æ ¡æ­£åŸºæº–(ç©ºç™½å¹³å‡ vs DPPH):,${blankAverageData.deltaE_Blank_Ref.toFixed(4)}\n`;
             csv += `100% æ¸…é™¤ç‡æ ¡æ­£ Delta E (ç¶­ç”Ÿç´ C):,${blankAverageData.VitC_Ref_Calibrated_DeltaE.toFixed(4)}\n`;


            // å‰µå»º Blob å’Œä¸‹è¼‰é€£çµ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const today = new Date().toISOString().slice(0, 10);
            const filename = `DPPH_Analysis_Report_${today}.csv`;

            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            document.getElementById('analysisMessage').textContent = `ğŸ’¾ ${filename} å·²æˆåŠŸåŒ¯å‡º!`;
            document.getElementById('analysisMessage').classList.replace('text-red-600', 'text-green-600');
        }


        // åˆ‡æ›å…¬å¼é¡¯ç¤ºç‹€æ…‹
        function toggleFormulas() {
            const content = document.getElementById('formulaContent');
            const button = document.getElementById('formulaButton');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                button.textContent = 'éš±è—è¨ˆç®—å…¬å¼ (é»æ“Šæ”¶åˆ) ğŸ”½';
            } else {
                content.classList.add('hidden');
                button.textContent = 'é¡¯ç¤ºè¨ˆç®—å…¬å¼ (é»æ“Šå±•é–‹) ğŸ”¼';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.onload = function() {
            // åˆå§‹åŒ– currentGroups ç‹€æ…‹
            currentGroups = INITIAL_GROUP_DEFS.slice();
            // æ‰¾åˆ°åˆå§‹æ¨£å“çµ„çš„æœ€å¤§è¨ˆæ•¸
            INITIAL_GROUP_DEFS.forEach(g => {
                if (g.key.startsWith('Sample_0')) {
                    sampleCounter++;
                }
            });

            createInputTable(); // å‰µå»ºè¼¸å…¥è¡¨æ ¼
            runAnalysis(); // é è¨­åŸ·è¡Œä¸€æ¬¡åˆ†æ
        };
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">DPPH æŠ—è‡ªç”±åŸºè©¦ç´™åˆ†æå„€</h1>
            <p class="text-gray-500">åŸºæ–¼ CIE L*a*b* æ•¸æ“šçš„è‰²å·® $(\Delta E)$ èˆ‡ DPPH æ¸…é™¤ç‡ (%) åˆ†æ</p>
        </header>
        
        <!-- æ•¸æ“šè¼¸å…¥å€ -->
        <section class="mb-8 p-6 bg-white rounded-xl shadow-xl border-t-4 border-blue-500">
            <h2 class="text-xl font-bold text-blue-700 mb-4">æ•¸æ“šè¼¸å…¥ (CIE L*a*b*)</h2>
            <div class="table-responsive mb-4">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-blue-600">
                        <tr>
                            <th class="text-left rounded-tl-lg">çµ„åˆ¥æè¿° / æ¨£å“æ¿ƒåº¦ (å¯ç·¨è¼¯)</th>
                            <th>L</th>
                            <th>a*</th>
                            <th>b*</th>
                            <th class="action-cell rounded-tr-lg">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inputTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Input fields will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                <button onclick="addSampleGroup()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md transform hover:scale-[1.01]">
                    â• å¢åŠ æ¨£å“çµ„
                </button>
                <button onclick="runAnalysis()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md transform hover:scale-[1.01]">
                    ğŸš€ åŸ·è¡Œåˆ†æèˆ‡è¨ˆç®—
                </button>
                <button id="downloadCsvButton" onclick="exportToCSV()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md transform hover:scale-[1.01]" disabled>
                    ğŸ’¾ ä¸‹è¼‰ CSV æª”æ¡ˆ
                </button>
            </div>
            <p id="analysisMessage" class="mt-3 text-center text-sm font-medium text-green-600"></p>
        </section>

        <!-- æ•¸æ“šæ‘˜è¦èˆ‡æ ¡æ­£åŸºæº– -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4 mt-8">åˆ†æçµæœ</h2>
        <div id="summary">
            <!-- Summary will be inserted here by JavaScript -->
        </div>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">çµæœè©³ç´°åˆ—è¡¨</h2>
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="text-left rounded-tl-lg">çµ„åˆ¥æè¿°</th>
                            <th>L</th>
                            <th>a*</th>
                            <th>b*</th>
                            <th>æœªæ ¡æ­£ $\Delta E$</th>
                            <th>æ ¡æ­£ $\Delta E$</th>
                            <th class="rounded-tr-lg">DPPH æ¸…é™¤ç‡ (%)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Results will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- è¨ˆç®—å…¬å¼èªªæ˜å€å¡Š -->
        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-gray-400">
            <button id="formulaButton" onclick="toggleFormulas()" class="w-full text-left font-bold text-lg text-gray-700 py-2 focus:outline-none">
                é¡¯ç¤ºè¨ˆç®—å…¬å¼ (é»æ“Šå±•é–‹) ğŸ”¼
            </button>
            <div id="formulaContent" class="hidden">
                <h3 class="text-base font-semibold text-gray-800 mt-2 mb-2">1. CIE L\*a\*b\* è‰²å·® ($\Delta E$)</h3>
                <p class="text-sm text-gray-600 mb-1">ç”¨æ–¼å®šé‡æ¯”è¼ƒ DPPH ç´«è‰²çµ„ ($L_1, a_1, b_1$) èˆ‡ä»»ä¸€å¯¦é©—çµ„ ($L_2, a_2, b_2$) çš„é¡è‰²è®ŠåŒ–ã€‚</p>
                <div class="formula-box">
                    $$\Delta E = \sqrt{(L_2 - L_1)^2 + (a_2 - a_1)^2 + (b_2 - b_1)^2}$$
                </div>

                <h3 class="text-base font-semibold text-gray-800 mt-4 mb-2">2. æ ¡æ­£ $\Delta E$ (Adjusted $\Delta E$)</h3>
                <p class="text-sm text-gray-600 mb-1">ä½¿ç”¨ $\Delta E_{\text{ç©ºç™½åŸºæº–}}$ (ç©ºç™½å¹³å‡ vs DPPH) ä½œç‚ºé™¤æ³•æ ¡æ­£å› å­ï¼Œä»¥æ¶ˆé™¤èƒŒæ™¯å¹²æ“¾ã€‚</p>
                <div class="formula-box">
                    $$\Delta E_{\text{æ ¡æ­£}} = \frac{\Delta E_{\text{çµ„åˆ¥ vs DPPH}}}{\Delta E_{\text{ç©ºç™½åŸºæº–}}}$$
                </div>

                <h3 class="text-base font-semibold text-gray-800 mt-4 mb-2">3. DPPH æ¸…é™¤ç‡ (%) è¨ˆç®—</h3>
                <p class="text-sm text-gray-600 mb-1">ä»¥ $0.1 \text{ mg/mL}$ ç¶­ç”Ÿç´  C çµ„çš„æ ¡æ­£ $\Delta E$ ($\Delta E_{\text{VitC, æ ¡æ­£}}$) ä½œç‚º $100\%$ åŸºæº–ã€‚</p>
                <div class="formula-box">
                    $$\text{DPPH æ¸…é™¤ç‡}(\%) = \frac{\Delta E_{\text{æ¨£å“çµ„, æ ¡æ­£}}}{\Delta E_{\text{VitC, æ ¡æ­£}}} \times 100\%$$
                </div>
            </div>
        </section>
        
        <footer class="text-sm text-gray-400 mt-8 pt-4 border-t">
            <p>åˆ†ææ–¹æ³•ï¼š$\Delta E$ è‰²å·®å€¼è¨ˆç®—ï¼Œä»¥ç©ºç™½è©¦ç´™å¹³å‡å€¼ç‚ºæ ¡æ­£åŸºæº–ï¼ˆé™¤æ³•æ ¡æ­£ï¼‰ï¼Œä¸¦ä»¥ 0.1 mg/mL ç¶­ç”Ÿç´ Cçµ„ä½œç‚º 100% æ¸…é™¤ç‡å°ç…§çµ„ã€‚</p>
        </footer>

    </div>

</body>
</html>
